# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Documentation Structure

**For users and general documentation**, see:
- **[Quick Start](docs/README.md)** - Installation and basic setup
- **[Detailed Setup](docs/SETUP.md)** - Step-by-step configuration
- **[Architecture](docs/ARCHITECTURE.md)** - System design and components
- **[Troubleshooting](docs/TROUBLESHOOTING.md)** - Common issues and solutions
- **[API Reference](docs/API.md)** - Code documentation

**This file (CLAUDE.md)** contains AI assistant-specific context, project conventions, and development notes that supplement the user-facing documentation.

## Project Overview

akam-proxy is a Node.js proxy server that automatically selects the optimal CDN node for **multiple Bilibili overseas CDN domains** by testing latency and choosing the lowest-delay server for each domain independently.

**Supported Domains**:
- **Akamai CDN**: `*.akamaized.net` (e.g., upos-hz-mirrorakam.akamaized.net)
- **BiliVideo CDN**: `*.bilivideo.com` (e.g., upos-sz-mirroraliov.bilivideo.com)

**Critical Architecture**: Each domain has its own **dedicated IP pool**. IPs are NOT interchangeable between domains - an IP that works for Akamai will not work for BiliVideo and vice versa.

## Getting Started

### Prerequisites
- Node.js installed (tested with v24.x)
- Required files: `config.json5` must exist in project root
- IP list files will be auto-generated by akamTester (or can be created manually)

### Setup Steps
1. **Install dependencies**:
   ```bash
   npm install
   ```

2. **Verify configuration**: Check `config.json5` exists and port 2689 is available (or modify port if needed)

3. **Start the proxy server**:
   ```bash
   npm start
   ```

4. **Verify startup**: Should see:
   - "Pinging ipList" - Server testing begins
   - "forward proxy server started, listening on port 2689"
   - "The best server is X.X.X.X which delay is XXXms"

5. **Configure browser**: Set up proxy extension (see Troubleshooting section for details)

## Common Commands

### Development
```bash
# Install dependencies
npm install

# Start the proxy server
npm start
```

### Configuration
- Configuration file: `config.json5` (JSON5 format, root directory)
- Example configs: `config/default.json5`, `config/example.json5`
- IP lists: Domain-specific files in `data/` directory:
  - `data/akamaized.net_iplist.txt` - IPs for Akamai CDN
  - `data/bilivideo.com_iplist.txt` - IPs for BiliVideo CDN
- Validation: Automatic on startup via `src/utils/validators.js`

## Architecture

**Note**: For detailed architecture documentation, see [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md)

### Core Components (After Phase 1 & 2 Restructure)

**Entry Point: `index.js`** (24 lines)
- Loads and validates configuration from `config.json5`
- Creates `Server` instance
- Handles graceful shutdown

**Application Manager: `src/core/server.js`**
- Coordinates all subsystems (DomainManager, proxy, akamTester)
- Manages periodic refresh and discovery timers
- Initializes and starts all services
- Builds domain configurations from `config.akamTester.targetHosts`
- Extracts domain patterns (e.g., 'upos-hz-mirrorakam.akamaized.net' → 'akamaized.net')

**Domain Manager: `src/core/domain-manager.js`** ⭐ NEW
- **Critical component** for multi-domain support
- Creates and manages multiple `IpPool` instances (one per domain)
- Maintains `domainMap`: Map<pattern, bestServer> (e.g., 'akamaized.net' → {host: '1.2.3.4', avg: 10})
- Coordinates IP testing and refresh across all domains
- Ensures IPs are NEVER mixed between domains
- Provides domain-specific IP pool access

**Proxy Server: `src/proxy/server.js`**
- Creates HTTP/HTTPS proxy server using Node.js `http` and `net` modules
- Handles HTTP requests via `httpOptions()` function
- Handles HTTPS CONNECT requests via `connect` event listener
- Uses `src/proxy/mapper.js` to map requests from specified domains to the optimal IP
- **Now receives domainMap instead of single best object**
- Pipes client requests to destination servers and returns responses
- Includes comprehensive debug logging (10-step for HTTP, 8-step for HTTPS)
- Enhanced clientError handler with rawPacket debugging

**Host Mapping: `src/proxy/mapper.js`** ⭐ UPDATED
- **Domain-aware routing**: Maps incoming requests to correct IP based on domain pattern
- Receives `domainMap` (Map<pattern, bestServer>) instead of single `best` object
- Matches hostname to domain pattern (e.g., 'upos-hz-mirrorakam.akamaized.net' matches 'akamaized.net')
- Routes to corresponding best IP for that domain
- Supports subdomain matching (e.g., 'sub.akamaized.net' matches 'akamaized.net')
- Logs proxy mappings when hostname is changed
- Returns modified `{ hostname, port }` for connection

**IP Testing: `src/ip-management/tester.js`**
- Dual-layer testing: TCP connection (network layer) + HTTP/HTTPS requests (application layer)
- Tests each IP 5 times per layer with 3 second timeout (default)
- Calculates comprehensive metrics: latency (avg/min/max), packet loss, jitter
- Weighted scoring: 40% TCP + 60% HTTP (app-level more important)
- Filters out dead IPs and sorts by combined score
- Supports verbose debug logging (see "Verbose Debug Mode" section)
- Returns array of alive servers sorted by best score

**IP Pool Manager: `src/ip-management/ip-pool.js`**
- Loads/saves IP list from domain-specific file (e.g., `data/akamaized.net_iplist.txt`)
- Tracks failure counts per IP
- Removes dead IPs after 5 consecutive failures
- Merges new discoveries with deduplication
- Enforces maximum pool size
- **Each domain has its own IpPool instance** - IPs are never mixed

**akamTester Integration: `src/ip-management/akam-runner.js`** ⭐ UPDATED
- Executes Python akamTester script in subprocess for MULTIPLE domains
- Validates Python/conda environment
- **Returns Map<targetHost, ips[]>** instead of merged array
- Parses separate output files for each domain:
  - `tools/akamTester/upos-hz-mirrorakam.akamaized.net_iplist.txt`
  - `tools/akamTester/upos-sz-mirroraliov.bilivideo.com_iplist.txt`
- **CRITICAL**: Keeps IPs separated by domain (no merging!)
- Handles timeouts and errors
- Mutex protection against concurrent runs

### Data Flow

**Multi-Domain Architecture** (v2.0+):

1. **On startup**:
   - Build domain configs from `config.akamTester.targetHosts`
   - Create DomainManager with one IpPool per domain
   - (Optional) Run akamTester to fetch fresh IPs for all domains
   - Load domain-specific IP lists from `data/` directory
   - Test all IPs for each domain independently
   - Select best server for each domain
   - Start proxy with domainMap

2. **Proxy request**:
   - Client request received
   - Extract hostname from request
   - Mapper matches hostname to domain pattern (e.g., '*.akamaized.net' → 'akamaized.net')
   - Mapper selects best IP from corresponding domain's pool
   - Forward request to selected IP
   - Return response to client

3. **Periodic refresh** (every hour, configurable):
   - Re-test all IPs for each domain independently
   - Update best server for each domain
   - Remove dead IPs (failed 5+ times)
   - Save updated IP lists

4. **Periodic discovery** (every 15 minutes, configurable):
   - Run akamTester for all target hosts
   - Get domain-specific IP lists (Map<targetHost, ips[]>)
   - Update each domain's IP pool separately
   - Re-test all IPs
   - Update best servers

### Configuration Structure

The `config.json5` file contains:
- `host`: **LEGACY** - No longer used in multi-domain mode (kept for backward compatibility)
- `port`: Local proxy server port (default: 2689)
- `refreshInterval`: How often to re-test IPs in seconds (applies to all domains)
- `verboseDebug`: Enable detailed TCP/HTTP ping logging (default: false, see "Verbose Debug Mode" section)
- `akamTester`: **CRITICAL** - Configuration for automated IP discovery with MULTI-DOMAIN support
  - `enabled`: Enable/disable akamTester integration
  - `validateOnStartup`: Fetch fresh IPs on startup (recommended: true)
  - `replaceMode`: Replace old IPs completely vs merge (recommended: true)
  - `interval`: How often to run akamTester (seconds)
  - `pythonPath`: Path to Python executable
  - `condaEnv`: Optional Conda environment name
  - `scriptPath`: Path to akamTester.py script
  - **`targetHosts`**: **CRITICAL** - Array of target CDN hostnames (each gets its own IP pool!)
    - Example: `['upos-hz-mirrorakam.akamaized.net', 'upos-sz-mirroraliov.bilivideo.com']`
    - Domain patterns extracted automatically: 'akamaized.net', 'bilivideo.com'
    - Each domain gets separate IP list file: `data/akamaized.net_iplist.txt`, etc.
  - `saveToFile`: Save updated IP lists to files (recommended: true)
  - `timeout`: Max execution time for akamTester (milliseconds)
  - `maxIps`: Maximum IPs per domain pool
- `refreshIpList.interval`: Legacy parameter (no longer used)
- `refreshIpList.retry.times`: Legacy parameter (no longer used)
- `refreshIpList.retry.interval`: Legacy parameter (no longer used)
- `saveChinazResult`: Legacy parameter (no longer used)

## Important Notes

### Multi-Domain Architecture (v2.0+)

⭐ **CRITICAL CHANGES**:
1. **Domain-Specific IP Pools**: Each domain (akamaized.net, bilivideo.com) has its own dedicated IP pool
2. **IPs are NOT interchangeable**: An IP that works for Akamai will NOT work for BiliVideo (connection will fail!)
3. **Automatic domain routing**: Mapper automatically detects domain pattern and selects correct IP pool
4. **Separate IP list files**:
   - `data/akamaized.net_iplist.txt` - Only for *.akamaized.net requests
   - `data/bilivideo.com_iplist.txt` - Only for *.bilivideo.com requests
5. **akamTester now returns Map**: `Map<targetHost, ips[]>` instead of single merged array

### General Behavior

- **Selective Proxy Behavior**: This is NOT a general-purpose HTTP proxy. It ONLY intercepts and redirects requests to specific domains (bilivideo.com, akamaized.net, etc.). All other requests pass through unchanged. This is a critical distinction - the proxy acts as a pass-through for everything except the specific CDN domains being optimized.
- The proxy modifies the destination hostname while preserving all other request parameters
- IPv6 addresses are filtered out (only IPv4 supported)
- The `domainMap` (Map<pattern, best>) is passed by reference to the proxy, so updates to optimal servers take effect immediately without restarting the proxy
- **Debug logging**: The proxy includes comprehensive step-by-step debug logging. This can be verbose but is helpful for troubleshooting Parse Errors and connection issues.

## Verbose Debug Mode (TCP + HTTP Ping Logging)

The proxy supports detailed debug logging for the dual-layer IP testing process. This feature provides comprehensive visibility into TCP and HTTP ping operations, which is invaluable for understanding server selection and troubleshooting network issues.

### Enabling Verbose Debug Mode

Add the `verboseDebug` option to your `config.json5`:

```json5
{
    host: 'upos-hz-mirrorakam.akamaized.net',
    port: 2689,
    refreshInterval: 3600,

    // Enable verbose debug logging
    verboseDebug: true,

    // ... rest of config
}
```

### What Gets Logged

When `verboseDebug: true`, you'll see:

1. **Test Initialization**:
   - Total number of IPs to test
   - Number of TCP and HTTP attempts per IP
   - Timeout and port settings
   - Scoring algorithm details (40% TCP + 60% HTTP weighted)

2. **Individual IP Test Results**:
   - TCP connection latency (avg/min/max)
   - HTTP/HTTPS request latency (avg/min/max)
   - Success rate for each test type
   - Combined score calculation
   - Packet loss percentage
   - Jitter (latency variance) metrics
   - Real-time progress (X/Y tested, Z% complete)

3. **Summary Statistics**:
   - Top 5 best performing IPs with detailed metrics
   - Average TCP/HTTP latency across all alive IPs
   - Latency ranges (min-max)
   - Overall packet loss percentage
   - Total alive vs dead IPs

### Example Output

**Without verbose mode** (default):
```
The best server is 23.47.72.160 which delay is 15.59ms
```

**With verbose mode** (`verboseDebug: true`):
```
╔══════════════════════════════════════════╗
║  Starting Dual-Layer IP Testing          ║
╠══════════════════════════════════════════╣
║  Total IPs to test: 89                   ║
║  TCP ping attempts: 5 per IP             ║
║  HTTPS ping attempts: 5 per IP           ║
║  Timeout: 3000ms per attempt             ║
║  Port: 443                               ║
║  Scoring: 40% TCP + 60% HTTP (weighted)  ║
╚══════════════════════════════════════════╝

  Testing 23.47.72.160:443...
    ✓ TCP: 12.45ms avg (5/5 success)
    ✓ HTTPS: 18.32ms avg (5/5 success)
    → Combined Score: 15.97ms (40% TCP + 60% HTTP)
    → Jitter: TCP 2.31ms, HTTP 3.12ms
[1/89] 1% - Tested 23.47.72.160

  Testing 2.16.11.163:443...
    ✓ TCP: 88.12ms avg (5/5 success)
    ✓ HTTPS: 92.45ms avg (5/5 success)
    → Combined Score: 90.74ms (40% TCP + 60% HTTP)
[2/89] 2% - Tested 2.16.11.163

  Testing 104.96.51.89:443...
    ✗ TCP: Failed (0/5 success)
    ✗ HTTPS: Failed (0/5 success)
[3/89] 3% - Tested 104.96.51.89

... (continues for all IPs) ...

╔══════════════════════════════════════════╗
║  IP Testing Complete                     ║
╠══════════════════════════════════════════╣
║  Tested: 89 IPs in 45.23s                ║
║  Alive: 77 IPs                           ║
║  Dead: 12 IPs                            ║
║  Total tests performed: 890 (TCP + HTTP) ║
╚══════════════════════════════════════════╝

╔══════════════════════════════════════════════════════════════╗
║  Top 5 Best Performing IPs                                   ║
╠══════════════════════════════════════════════════════════════╣
║  1. 23.47.72.160 - Score: 15.97ms (TCP: 12.45ms, HTTP: 18.32ms, Loss: 0.0%)  ║
║  2. 104.97.23.45 - Score: 22.13ms (TCP: 18.90ms, HTTP: 24.20ms, Loss: 0.0%)  ║
║  3. 184.25.56.78 - Score: 35.42ms (TCP: 31.20ms, HTTP: 38.10ms, Loss: 0.0%)  ║
║  4. 23.48.123.90 - Score: 42.88ms (TCP: 39.50ms, HTTP: 45.10ms, Loss: 0.0%)  ║
║  5. 2.16.11.163 - Score: 90.74ms (TCP: 88.12ms, HTTP: 92.45ms, Loss: 0.0%)   ║
╚══════════════════════════════════════════════════════════════╝

✓ Selected best server: 23.47.72.160 (score: 15.97ms)

╔══════════════════════════════════════════════════════════════╗
║  Testing Statistics Summary                                  ║
╠══════════════════════════════════════════════════════════════╣
║  Average TCP Latency: 125.34ms (range: 12.45-350.12ms)      ║
║  Average HTTP Latency: 138.67ms (range: 18.32-420.45ms)     ║
║  Average Combined Score: 133.21ms                            ║
║  Average Packet Loss: 2.34%                                  ║
║  Total Alive IPs: 77/89                                      ║
╚══════════════════════════════════════════════════════════════╝
```

### Understanding the Metrics

**TCP Latency**: Connection-level latency (network layer)
- Measures raw TCP connection establishment time
- Lower-level network performance indicator
- Weighted 40% in final score

**HTTP/HTTPS Latency**: Application-level latency
- Measures full request-response time
- Real-world proxy performance indicator
- Weighted 60% in final score (more important)

**Combined Score**: Weighted average with packet loss penalty
- Formula: `(TCP_avg * 0.4 + HTTP_avg * 0.6) * (1 + packet_loss/100)`
- Lower score = better performance
- Used for server selection

**Packet Loss**: Percentage of failed test attempts
- 0% = all attempts succeeded
- >0% = some attempts timed out or failed
- Increases combined score as penalty

**Jitter**: Standard deviation of latency measurements
- Measures latency consistency/variance
- Lower jitter = more stable connection
- High jitter = unstable/congested network

### Performance Impact

**With `verboseDebug: false` (default)**:
- Minimal console output
- Faster startup (no formatting overhead)
- Recommended for production

**With `verboseDebug: true`**:
- Detailed console output (can be very long with many IPs)
- Slightly slower due to logging overhead (~1-2 seconds)
- Recommended for:
  - Debugging network issues
  - Understanding server selection
  - Monitoring IP pool health
  - Development and testing

### When to Use Verbose Mode

✅ **Enable when**:
- Debugging why certain IPs are selected/rejected
- Investigating packet loss or high latency
- Understanding scoring algorithm behavior
- Monitoring IP pool quality over time
- Troubleshooting akamTester integration

❌ **Disable when**:
- Running in production (too much log spam)
- You trust the automatic selection
- Console output is redirected to files (large files)
- Running as a background service

### Implementation Details

**Location**:
- Testing logic: `src/ip-management/tester.js`
- IP pool management: `src/ip-management/ip-pool.js`
- Server initialization: `src/core/server.js`

**How it works**:
1. `config.verboseDebug` flag is read at startup
2. Passed to `IpPool` constructor → stored as `this.verbose`
3. Passed to `tester()` function as `{ verbose: true/false }`
4. Tester uses `logger.box()` and `logger.log()` for formatted output
5. IP pool uses verbose flag to show/hide top performers and statistics

## Troubleshooting

### EADDRINUSE Error (Port Already in Use)

**Problem**: `Error: listen EADDRINUSE: address already in use :::2689`

**Cause**: Another process is already using port 2689, or a previous instance of the proxy server is still running.

**Solutions**:

1. **Find and kill the process using the port**:
   - Windows: `netstat -ano | findstr :2689` then `taskkill /PID <PID> /F`
   - Linux/Mac: `lsof -i :2689` then `kill -9 <PID>`

2. **Change the port in `config.json5`**:
   ```json5
   {
       port: 3000,  // Use a different port
       // ... other config
   }
   ```

3. **Check for zombie processes**: If you've stopped the server with Ctrl+C, check Task Manager/Activity Monitor for lingering Node.js processes

### Browser Proxy Configuration Issues

**Problem**: Browser proxy extension (e.g., ZeroOmega, SwitchyOmega) doesn't work with the proxy.

**Root Cause Understanding**: This proxy is designed SPECIFICALLY for Bilibili's CDN domains (bilivideo.com, akamaized.net). It will not optimize or affect traffic to other domains. The proxy passes through all non-matching requests unchanged.

**Proper Configuration**:

1. **For SwitchyOmega/ZeroOmega - Use Selective Proxy Mode**:
   - Create a new proxy profile with server `127.0.0.1` and port `2689` (HTTP proxy)
   - In "Switch Rules" or "Auto Switch" mode, add a rule:
     - Condition Type: Host wildcard
     - Pattern: `*.akamaized.net` or specifically `upos-hz-mirrorakam.akamaized.net`
     - Profile: Your proxy profile
   - This ensures only Bilibili CDN requests go through the proxy

2. **Do NOT use "Proxy all requests" mode** unless you understand that only matching domains will be optimized while other requests pass through normally.

3. **Verify the proxy is working**:
   - Start the proxy server: `npm start`
   - Check console output: Should show "forward proxy server started, listening on port 2689"
   - Watch for "proxy request" logs when accessing Bilibili videos
   - Logs like `proxy request: upos-hz-mirrorakam.akamaized.net:443 => 23.x.x.x:443` confirm the proxy is working

4. **Testing without browser extension**:
   - You can manually set system-wide proxy settings to `127.0.0.1:2689` for testing
   - Or use curl: `curl -x http://127.0.0.1:2689 http://example.com` (will pass through)

### No Proxy Logs Appearing

**Problem**: Proxy server starts successfully but no "proxy request" logs appear when browsing.

**Causes**:
1. Browser extension not configured correctly (see above)
2. The website you're visiting doesn't use matching domains - only Bilibili video streams use these CDNs
3. Browser is caching DNS or using QUIC/HTTP3 which bypasses the proxy

**Solutions**:
1. Test specifically with Bilibili video playback (https://www.bilibili.com/video/*)
2. Clear browser cache and disable QUIC in browser settings
3. Check that the browser extension is active (icon should indicate proxy is enabled)

### Excessive Debug Logging

**Problem**: Console output is flooded with 10-step debug logs for every HTTP request.

**Cause**: Debug logging was added to diagnose Parse Errors and is currently always enabled.

**Solution**: To disable debug logging, edit `libs/proxy.js`:
- Comment out or remove `console.log()` statements in lines 13-44 (HTTP handler)
- Comment out or remove `console.log()` statements in lines 91-125 (HTTPS handler)
- Keep the error logging (`console.error()`) for troubleshooting

## IP Address Management

**Multi-Domain Architecture**: The proxy now manages SEPARATE IP lists for each domain. Each domain has its own dedicated file and IP pool.

**IP List Files**:
- `data/akamaized.net_iplist.txt` - IPs for Akamai CDN (*.akamaized.net)
- `data/bilivideo.com_iplist.txt` - IPs for BiliVideo CDN (*.bilivideo.com)

⚠️ **CRITICAL**: Do NOT mix IPs between domains! An IP from one domain will NOT work for another domain.

### Manual Update via DNS Query

Quick method using nslookup or dig for each domain:

```bash
# For Akamai CDN
nslookup upos-hz-mirrorakam.akamaized.net
# Save IPs to data/akamaized.net_iplist.txt

# For BiliVideo CDN
nslookup upos-sz-mirroraliov.bilivideo.com
# Save IPs to data/bilivideo.com_iplist.txt

# Or on Linux/Mac:
dig upos-hz-mirrorakam.akamaized.net
dig upos-sz-mirroraliov.bilivideo.com
```

Copy the resulting IP addresses into the **correct domain-specific file** (one IP per line) and restart the proxy server.

### Using akamTester (Recommended)

The project includes `tools/akamTester/` - a Python tool for discovering and testing CDN IPs.

**akamTester v6.0** by @Miyouzi and @oldip:
- Discovers IPs for multiple CDN domains using global DNS queries
- Tests HTTPS connection latency to find optimal nodes
- **Generates separate output files for each domain** (critical for multi-domain support!)
- More comprehensive than simple DNS queries

**Manual Usage** (for testing):

1. **Install dependencies**:
   ```bash
   cd tools/akamTester
   pip install -r requirements.txt
   ```

2. **Run for multiple domains**:
   ```bash
   python akamTester.py -u upos-hz-mirrorakam.akamaized.net upos-sz-mirroraliov.bilivideo.com
   ```

3. **Check output files**:
   - `upos-hz-mirrorakam.akamaized.net_iplist.txt` (Akamai IPs)
   - `upos-sz-mirroraliov.bilivideo.com_iplist.txt` (BiliVideo IPs)

4. **Manual update** (not recommended - use automated integration instead):
   - Copy IPs from `upos-hz-mirrorakam.akamaized.net_iplist.txt` to `data/akamaized.net_iplist.txt`
   - Copy IPs from `upos-sz-mirroraliov.bilivideo.com_iplist.txt` to `data/bilivideo.com_iplist.txt`
   - Restart proxy

**Note**: akamTester may show occasional timeout errors for viewdns.info. This is a non-critical network/external service issue. The script handles this gracefully and still discovers plenty of IPs from other sources (4 other web sources + 15 public DNS servers).

**Recommended**: Use the **automated integration** instead (see next section)!

## Automated IP Discovery (akamTester Integration)

**MULTI-DOMAIN SUPPORT**: The proxy now supports fully automated IP discovery with **startup validation** for **MULTIPLE domains**! Fresh domain-specific IPs on every restart.

### Overview

The akamTester integration automatically:
- **Validates IPs immediately on startup** for ALL domains (recommended)
- Runs akamTester.py periodically (default: every 15 minutes)
- Discovers new CDN IPs from global DNS sources **for each domain separately**
- **Replaces** old IPs with fresh ones (default, recommended for Bilibili's rotating CDN)
- Tests all IPs with dual-layer testing (TCP + HTTP) and selects the best one **per domain**
- Removes dead IPs automatically after 5 consecutive failures
- Saves updated IP lists to domain-specific files:
  - `data/akamaized.net_iplist.txt`
  - `data/bilivideo.com_iplist.txt`

**Why Startup Validation?** Bilibili's CDN IPs rotate frequently and expire quickly. Even if an old IP passes ping/HTTP tests, it may no longer work for actual video connections. Running akamTester on startup ensures you always have fresh, valid IPs.

**Why Multi-Domain?** Each CDN (Akamai, BiliVideo) has its own IP pool. An IP from one domain will NOT work for another domain. Keeping them separate ensures reliable connections.

**Architecture**: Uses akamTester for **IP discovery** (comprehensive but slow) and dual-layer testing for **IP selection** (fast and responsive to current network conditions).

### Quick Start

1. **Install Python dependencies**:
   ```bash
   cd tools/akamTester
   pip install -r requirements.txt
   cd ../..
   ```

2. **Enable in config.json5**:
   ```json5
   {
       akamTester: {
           enabled: true,              // Enable automatic discovery
           validateOnStartup: true,    // Run immediately on startup (recommended!)
           replaceMode: true,          // Replace old IPs (recommended!)
           interval: 900,              // Run every 15 minutes
           pythonPath: 'python',       // Adjust if needed (or set condaEnv)
           // ... other settings use defaults
       }
   }
   ```

3. **Start the proxy**:
   ```bash
   npm start
   ```

4. **Verify it's working**:
   - Look for "STARTUP IP VALIDATION" box in logs
   - You'll see "Running akamTester to fetch fresh IPs..."
   - Watch for "IP list replaced: X → Y IPs (Y fresh from akamTester)"
   - Then see "Saved fresh IP list to data/ip_list.txt"
   - Finally see dual-layer testing and best server selection

### How It Works

**Startup Flow (with `validateOnStartup: true`, recommended)**:
1. Server initializes akamTester integration
2. **Immediately runs akamTester** to fetch fresh IPs from global DNS (2-5 minutes)
3. **Replaces old ip_list.txt** with fresh IPs (if `replaceMode: true`)
4. Saves fresh IP list to file
5. Tests all fresh IPs with dual-layer testing (TCP + HTTP)
6. Selects best server and starts proxy
7. **Every 15 minutes** (configurable), runs akamTester again to refresh

**Startup Flow (with `validateOnStartup: false`, legacy behavior)**:
1. Server loads existing `ip_list.txt`
2. Tests all IPs with dual-layer testing
3. Selects best server and starts proxy
4. **After 30 seconds**, runs first akamTester discovery (background)
5. **Every 15 minutes** (configurable), runs akamTester again

**Discovery Cycle (during periodic refresh)**:
1. akamTester queries global DNS sources (2-5 minutes)
2. **Replace mode** (`replaceMode: true`, default): Completely replaces old IPs with fresh ones
3. **Merge mode** (`replaceMode: false`): Merges new IPs with existing list (deduplication)
4. Updated list saved to `ip_list.txt` (if `saveToFile: true`)
5. All IPs re-tested with dual-layer testing (~10 seconds per IP)
6. Best server selected and proxy updated (no restart needed!)

**Dead IP Removal**:
- Every time `refreshBest()` runs (every hour by default)
- IPs that fail tcp-ping get failure count incremented
- IPs that succeed get failure count reset to 0
- After 5 consecutive failures, IP is removed from list
- Updated list saved to `ip_list.txt`

### Configuration Options

**File**: `config.json5` → `akamTester` section

| Option | Default | Description |
|--------|---------|-------------|
| `enabled` | `false` | Enable/disable automatic IP discovery |
| `validateOnStartup` | `false` | **[NEW]** Run akamTester immediately on startup (before loading ip_list.txt). **Recommended: `true`** for Bilibili's rotating CDN IPs |
| `replaceMode` | `true` | **[NEW]** Replace old IPs completely (true) or merge with existing (false). **Recommended: `true`** to ensure fresh IPs |
| `interval` | `900` | How often to run akamTester (seconds). Recommended: 900 (15min), 1800 (30min), 3600 (1hr) |
| `pythonPath` | `'python'` | Path to Python executable. Windows: `'python'` or `'C:\\Python312\\python.exe'`. Linux/Mac: `'python3'` or `'/usr/bin/python3'` |
| `condaEnv` | `null` | Conda environment name (optional). If set, uses `conda run -n <env> python`. Example: `'AKAMTester'` |
| `scriptPath` | `'tools/akamTester/akamTester.py'` | Path to akamTester.py (relative to project root) |
| `targetHosts` | `['upos-hz-mirrorakam.akamaized.net']` | Array of CDN domains to discover IPs for |
| `saveToFile` | `true` | Save updated IP list to `ip_list.txt` (persists across restarts) |
| `timeout` | `600000` | Max execution time for akamTester in milliseconds (10 minutes) |
| `maxIps` | `200` | Maximum IPs to keep in pool (prevents unlimited growth) |

**Example Configuration**:

```json5
{
    host: 'upos-hz-mirrorakam.akamaized.net',
    port: 2689,
    refreshInterval: 3600,

    akamTester: {
        enabled: true,              // Turn on automatic discovery
        validateOnStartup: true,    // Fetch fresh IPs on startup (recommended!)
        replaceMode: true,          // Replace old IPs completely (recommended!)
        interval: 900,              // Run every 15 minutes
        pythonPath: 'python3',      // Linux/Mac users might need this
        condaEnv: 'AKAMTester',     // Optional: use conda environment
        scriptPath: 'tools/akamTester/akamTester.py',
        targetHosts: ['upos-hz-mirrorakam.akamaized.net'],
        saveToFile: true,           // Persist discoveries
        timeout: 600000,            // 10 minute timeout
        maxIps: 200                 // Keep best 200 IPs
    }
}
```

### Troubleshooting

#### Problem: "Python executable not found"

**Cause**: Python is not installed or `pythonPath` is incorrect.

**Solution**:
1. Install Python 3: https://www.python.org/downloads/
2. Or update `pythonPath` in `config.json5`:
   ```json5
   pythonPath: 'C:\\Python312\\python.exe'  // Windows full path
   pythonPath: '/usr/bin/python3'            // Linux/Mac full path
   ```

#### Problem: "akamTester execution failed"

**Cause**: Python dependencies not installed or script error.

**Solution**:
1. Run manually to diagnose:
   ```bash
   cd python/akamTester-master
   python akamTester.py -u upos-hz-mirrorakam.akamaized.net
   ```
2. Install missing dependencies:
   ```bash
   pip install -r requirements.txt
   ```

#### Problem: IP list not updating

**Cause**: Various - check logs for specific error.

**Solutions**:
- Verify Python is working: `python --version`
- Check akamTester runs manually: `cd python/akamTester-master && python akamTester.py`
- Look for error messages in server logs
- Verify `saveToFile: true` in config
- Check file permissions on `ip_list.txt`

#### Problem: "akamTester timeout"

**Cause**: akamTester taking longer than `timeout` setting (usually due to slow DNS sources).

**Solutions**:
- Increase timeout in config: `timeout: 900000` (15 minutes)
- This is usually not a problem - server continues with existing IPs

#### Problem: "akamTester is already running, skipping this interval"

**Cause**: Previous akamTester run is still executing when next interval triggers.

**Solution**: This is normal behavior (mutex protection). Either:
- Increase `interval` to give more time: `interval: 1800` (30 minutes)
- Decrease `timeout` to kill slow runs faster (not recommended)

#### Problem: Too many/few IPs in list

**Cause**: `maxIps` setting and dead IP removal logic.

**Solutions**:
- Adjust `maxIps` in config: `maxIps: 300` for more IPs
- Dead IPs are automatically removed after 5 failures
- Manually edit `ip_list.txt` to remove unwanted IPs

### Graceful Degradation

The akamTester integration is designed to **never break your proxy**:

✅ If Python is not installed → Warning logged, proxy continues with existing IPs
✅ If akamTester fails → Error logged, proxy continues with existing IPs
✅ If timeout occurs → Process killed, proxy continues with existing IPs
✅ If feature is disabled → Proxy works exactly as before

**The proxy will always work**, even if akamTester is completely broken!

### Performance Impact

- **Startup**: No impact (akamTester runs 30 seconds after startup)
- **During discovery**: No impact (runs asynchronously in background)
- **During re-testing**: Brief CPU spike for tcp-ping (~10 seconds every 15 minutes)
- **Memory**: Negligible (~1-2 KB per IP, max 200 IPs = ~400 KB)

### Logs to Expect

**When enabled with startup validation** (`validateOnStartup: true`, recommended):
```
╔══════════════════════════════════════════════════════════════╗
║  akamTester Integration ENABLED                              ║
╚══════════════════════════════════════════════════════════════╝
Discovery interval: 900s (15 minutes)
Python environment: Conda environment 'AKAMTester'
Target hosts: upos-hz-mirrorakam.akamaized.net
Max IPs: 200

╔══════════════════════════════════════════════════════════════╗
║  STARTUP IP VALIDATION                                       ║
╠══════════════════════════════════════════════════════════════╣
║  Running akamTester to fetch fresh IPs...                    ║
║  Old ip_list.txt will be replaced with fresh results         ║
║  This ensures no expired/rotated IPs are used                ║
╚══════════════════════════════════════════════════════════════╝

Executing akamTester.py...
Working directory: /home/user/akam-proxy/tools/akamTester
Running: conda run -n AKAMTester python akamTester.py -u upos-hz-mirrorakam.akamaized.net
[akamTester] 当前 akamTester 版本: 6.0
[akamTester] 当前测试域名：upos-hz-mirrorakam.akamaized.net
...
akamTester discovered 124 IPs
IP list replaced: 89 → 124 IPs (124 fresh from akamTester)
✓ Saved fresh IP list to data/ip_list.txt

╔══════════════════════════════════════════════════════════════╗
║  Startup validation completed                                ║
╠══════════════════════════════════════════════════════════════╣
║  Fresh IP list ready with 124 IPs                            ║
╚══════════════════════════════════════════════════════════════╝

Loaded 124 IP addresses from data/ip_list.txt
Pinging ipList
[... dual-layer testing output ...]
The best server is 23.47.72.160 which delay is 15.59ms

forward proxy server started, listening on port 2689
Periodic akamTester runs scheduled every 15 minutes
```

**When enabled without startup validation** (`validateOnStartup: false`, legacy):
```
╔══════════════════════════════════════════════════════════════╗
║  akamTester Integration ENABLED                              ║
╚══════════════════════════════════════════════════════════════╝
Discovery interval: 900s (15 minutes)
Python path: python
Target hosts: upos-hz-mirrorakam.akamaized.net
Max IPs: 200

First akamTester run scheduled in 30 seconds...
Subsequent runs every 15 minutes
```

**During periodic discovery (replace mode)**:
```
╔══════════════════════════════════════════════════════════════╗
║  Running akamTester to discover new IPs                      ║
╠══════════════════════════════════════════════════════════════╣
║  Current IP list size: 77                                    ║
║  Mode: REPLACE (old IPs will be wiped)                       ║
╚══════════════════════════════════════════════════════════════╝
Executing akamTester.py...
Running: python tools/akamTester/akamTester.py -u upos-hz-mirrorakam.akamaized.net
[akamTester] 当前 akamTester 版本: 6.0
[akamTester] 当前测试域名：upos-hz-mirrorakam.akamaized.net
...
akamTester discovered 132 IPs
IP list replaced: 77 → 132 IPs (132 fresh from akamTester)
✓ Saved updated IP list to data/ip_list.txt
Re-testing all IPs with dual-layer testing to find the best server...
Pinging ipList
The best server is 2.16.11.163 which delay is 88.24ms

╔══════════════════════════════════════════════════════════════╗
║  IP refresh cycle completed                                  ║
╚══════════════════════════════════════════════════════════════╝
```

**During periodic discovery (merge mode)**:
```
╔══════════════════════════════════════════════════════════════╗
║  Running akamTester to discover new IPs                      ║
╠══════════════════════════════════════════════════════════════╣
║  Current IP list size: 77                                    ║
║  Mode: MERGE (combine with existing)                         ║
╚══════════════════════════════════════════════════════════════╝
Executing akamTester.py...
[... output ...]
Discovered 48 IPs (12 new, 36 already known)
IP list updated: 77 → 89 IPs
✓ Saved updated IP list to data/ip_list.txt
[... rest of output ...]
```

**When dead IPs are removed**:
```
Removing 3 dead IP(s) (failed 5+ times consecutively):
  - Removed: 23.45.67.89
  - Removed: 98.76.54.32
  - Removed: 12.34.56.78
✓ Updated ip_list.txt (now 86 IPs)
```

### Comparison: Manual vs Automated

| Aspect | Manual (akamTester CLI) | Automated (Integration) | Automated + Startup Validation |
|--------|------------------------|-------------------------|-------------------------------|
| Setup | Run script, copy IPs, paste, restart | Enable in config, done! | Enable + validateOnStartup, done! |
| Fresh IPs on startup | Manual run required | Uses cached ip_list.txt | **Always fresh** (runs akamTester first) |
| Frequency | Whenever you remember | Every 15 minutes automatically | Startup + every 15 minutes |
| Server restart needed | Yes | No | No |
| Effort | High (manual each time) | Zero (fully automatic) | Zero (fully automatic) |
| Dead IP removal | Manual | Automatic after 5 failures | Automatic after 5 failures |
| IP rotation handling | Poor (stale IPs) | Good (periodic refresh) | **Excellent** (always fresh) |
| Best for | One-time setup | Production | **Production (recommended!)** |

**Recommendation**:
- **Production**: Use automated integration with `validateOnStartup: true` and `replaceMode: true` (best)
- **Development**: Use automated integration with default settings (good)
- **Testing/No Python**: Use manual method (basic)

## Code History and Bug Fixes

This codebase has undergone significant debugging and improvements. The following issues were identified and fixed:

### Major Fixes Applied

1. **chinazPing Removal** (November 2025)
   - Removed unreliable chinaz.com scraping functionality
   - chinaz.com changed to dynamic JavaScript with encrypted tokens, making scraping impossible
   - Simplified codebase and improved startup performance
   - Users now update IPs manually via nslookup or akamTester

2. **Parse Error Fix** (November 2025)
   - Fixed URL object incompatibility in proxy.js
   - `new URL()` returns URL objects, but proxyMap expected plain objects
   - Added conversion step: URL object → plain `{hostname, port}` object
   - All HTTP/HTTPS proxy requests now work correctly

3. **Variable Scope Fix** (November 2025)
   - Fixed critical bug where `options`, `hostname`, `port` were declared inside try blocks
   - Variables were undefined when used outside try blocks
   - Moved declarations outside try blocks to proper scope
   - Eliminated intermittent Parse Errors

4. **Deprecated url.parse() Replacement** (January 2025)
   - Replaced deprecated `url.parse()` with WHATWG URL API (`new URL()`)
   - Eliminated deprecation warnings
   - Improved security and future-proofing

5. **Error Handling Improvements** (January 2025)
   - Distinguished expected disconnects (ECONNABORTED, ECONNRESET) from real errors
   - Added socket.destroyed checks before cleanup
   - Cleaner, less scary error logs

6. **Debug Logging Added** (November 2025)
   - Comprehensive 10-step debug logging for HTTP requests
   - 8-step debug logging for HTTPS CONNECT requests
   - Enhanced clientError handler with rawPacket hex dump
   - Makes future Parse Error debugging much easier

7. **Startup IP Validation** (November 2025)
   - Added `validateOnStartup` option to run akamTester immediately on startup
   - Added `replaceMode` option to replace old IPs instead of merging
   - Addresses Bilibili CDN's IP rotation policy (IPs expire quickly)
   - Even if old IPs pass ping/HTTP tests, they may not work for actual connections
   - Fresh IPs fetched on every restart ensures reliable video streaming
   - Configurable for backward compatibility (defaults to false)
   - Recommended settings: `validateOnStartup: true`, `replaceMode: true`

### Current Status

✅ **Parse Error completely fixed** (variable scope + URL object handling)
✅ **Comprehensive debug logging** for future troubleshooting
✅ **No chinaz-related errors** or warnings
✅ **Faster server selection** (dual-layer TCP + HTTP testing)
✅ **Cleaner startup output**
✅ **Simpler, more maintainable codebase**
✅ **Clear manual IP update instructions** via nslookup or akamTester
✅ **Python akamTester tool integrated** for advanced IP discovery
✅ **Startup IP validation** ensures fresh IPs on every restart
✅ **Replace mode** handles Bilibili's rotating CDN IPs effectively

The proxy is now fully functional, production-ready, and optimized for Bilibili's Akamai CDN with comprehensive debugging capabilities and automatic IP refresh on startup.

## Testing and Test Coverage

The project includes a comprehensive test suite with unit tests for all critical modules.

### Running Tests

```bash
# Run all tests
npm test

# Run tests with coverage report
npm run test:coverage

# Run specific test file
npm test -- tests/unit/ip-pool.test.js
```

### Test Coverage Summary

Current test coverage (as of v2.0.0):

| Module | Statements | Branches | Functions | Lines | Status |
|--------|------------|----------|-----------|-------|--------|
| **ip-pool.js** | 100% | 88.88% | 100% | 100% | ✅ Full Coverage |
| **tester.js** | 91.17% | 69.56% | 80.95% | 90.32% | ✅ Excellent |
| **mapper.js** | 100% | 100% | 100% | 100% | ✅ Full Coverage |
| **logger.js** | 100% | 100% | 100% | 100% | ✅ Full Coverage |
| **validators.js** | 71.42% | 70.51% | 100% | 69.49% | ✅ Good |
| **Overall** | 35.56% | 41.37% | 46.46% | 34.11% | ✅ Meets Thresholds |

**Coverage Thresholds** (enforced by Jest):
- Statements: 30% (current: 35.56%) ✅
- Branches: 35% (current: 41.37%) ✅
- Functions: 40% (current: 46.46%) ✅
- Lines: 30% (current: 34.11%) ✅

### Test Files Structure

```
tests/
├── unit/
│   ├── ip-pool.test.js      (26 tests) - IP management, dedup, dead IP removal
│   ├── tester.test.js       (14 tests) - Dual-layer latency testing, packet loss
│   ├── mapper.test.js       (7 tests)  - Domain mapping and proxy logic
│   ├── validators.test.js   (13 tests) - Config validation and IP format checking
│   ├── logger.test.js       (5 tests)  - Logging utilities
│   └── index.test.js        (7 tests)  - Entry point and dependencies
└── integration/
    └── (placeholder for future e2e tests)
```

**Total: 71+ test cases**

### What's Tested

✅ **IP Pool Management** (ip-pool.test.js):
- Loading/saving IP lists from files
- Dead IP tracking and removal (after 5 failures)
- IP deduplication and merging
- Handling different line endings (Unix, Windows, Mac)
- IPv6 filtering

✅ **Enhanced IP Testing** (tester.test.js):
- Dual-layer testing (TCP + HTTP/HTTPS)
- Packet loss calculation
- Jitter measurement (latency variance)
- Comprehensive metrics structure
- Weighted scoring algorithm (40% TCP + 60% HTTP)
- Backward compatibility with legacy fields

✅ **Domain Mapping** (mapper.test.js):
- Exact domain matching (upos-hz-mirrorakam.akamaized.net)
- Subdomain matching (*.bilivideo.com, *.akamaized.net)
- Pass-through for unrelated domains
- Port preservation

✅ **Configuration Validation** (validators.test.js):
- Config schema validation
- Port range checking (1-65535)
- Refresh interval limits
- IPv4 address format validation
- akamTester configuration validation

✅ **Utilities** (logger.test.js, index.test.js):
- Logging functions (log, error, warn, box)
- Entry point dependencies
- Config file existence and readability

### What's NOT Tested (Integration-Heavy)

❌ **Proxy Server** (src/proxy/server.js): Requires full HTTP/HTTPS server integration
❌ **Core Server** (src/core/server.js): Application lifecycle and timer management
❌ **akamTester Runner** (src/ip-management/akam-runner.js): Python subprocess integration

These modules are integration-heavy and difficult to unit test without extensive mocking. They are best tested manually or with end-to-end integration tests.

### CI/CD Integration

The project includes GitHub Actions workflow (`.github/workflows/test.yml`) that:
- Runs tests on Node.js 18, 20, 22
- Generates coverage reports
- Uploads coverage to Codecov
- Fails if coverage thresholds are not met

### Adding New Tests

When adding new functionality:

1. **Write tests first** (TDD approach recommended)
2. **Run tests locally**: `npm test`
3. **Check coverage**: `npm run test:coverage`
4. **Ensure thresholds are met** before committing
5. **Update this documentation** if coverage significantly improves

## Migration Guide: Single-Domain to Multi-Domain Architecture

**Version 2.0** introduced multi-domain support with separate IP pools per domain. If you're upgrading from v1.x, follow these steps:

### What Changed

1. **IP List Files**:
   - ❌ OLD: Single `data/ip_list.txt` for all domains
   - ✅ NEW: Domain-specific files:
     - `data/akamaized.net_iplist.txt`
     - `data/bilivideo.com_iplist.txt`

2. **Configuration**:
   - ❌ OLD: `config.host` (single domain)
   - ✅ NEW: `config.akamTester.targetHosts` (array of domains)

3. **Architecture**:
   - ❌ OLD: Single `IpPool` → single `best` object
   - ✅ NEW: `DomainManager` → multiple `IpPool` instances → `domainMap`

### Automatic Migration (Recommended)

**The proxy automatically migrates on startup!**

1. Update `config.json5`:
   ```json5
   {
       // Old config.host is now ignored (kept for compatibility)
       host: 'upos-hz-mirrorakam.akamaized.net',

       // Add akamTester with targetHosts
       akamTester: {
           enabled: true,
           validateOnStartup: true,  // Fetch fresh IPs on startup
           replaceMode: true,
           targetHosts: [
               'upos-hz-mirrorakam.akamaized.net',
               'upos-sz-mirroraliov.bilivideo.com'
           ]
       }
   }
   ```

2. Start the proxy:
   ```bash
   npm start
   ```

3. On startup, akamTester will:
   - Fetch fresh IPs for both domains
   - Create domain-specific IP list files
   - Test all IPs independently
   - Select best server for each domain
   - You're done! 🎉

### Manual Migration

If you prefer manual migration or don't have Python:

1. **Split existing IP list** (if you know which IPs belong to which domain):
   ```bash
   # Backup old file
   cp data/ip_list.txt data/ip_list.txt.backup

   # Create domain-specific files
   # (You'll need to manually identify which IPs belong to which domain)
   # This is NOT recommended - use automatic migration instead
   ```

2. **Or use DNS queries** for each domain:
   ```bash
   nslookup upos-hz-mirrorakam.akamaized.net > data/akamaized.net_iplist.txt
   nslookup upos-sz-mirroraliov.bilivideo.com > data/bilivideo.com_iplist.txt
   ```

3. Update `config.json5` as shown above

4. Start the proxy

### Troubleshooting Migration

**Problem**: "No IPs available for domain"

**Solution**:
- Enable `validateOnStartup: true` to fetch fresh IPs automatically
- Or manually add IPs to domain-specific files

**Problem**: Old `data/ip_list.txt` still exists

**Solution**:
- Safe to delete after migration (no longer used)
- Keep as backup if needed

**Problem**: Connection failures after migration

**Solution**:
- Ensure IPs are in correct domain-specific files
- Check that `targetHosts` in config matches your domains
- Enable `verboseDebug: true` to see detailed IP testing logs

## Future Development

From README.md:
- ✅ **Automate `ip_list.txt` updates**: COMPLETED in v2.0 with multi-domain akamTester integration
- ✅ **Multi-domain support**: COMPLETED in v2.0 with DomainManager architecture
- Future ideas:
  - IPv6 support
  - Custom domain patterns via config
  - Web dashboard for monitoring IP pools
  - API for programmatic control
