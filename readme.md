# akam-proxy

A Node.js proxy server that automatically selects the optimal CDN node for Bilibili's overseas CDN (`upos-hz-mirrorakam.akamaized.net`) by testing latency and choosing the lowest-delay server.

This project is designed to optimize video streaming from Bilibili by intelligently routing traffic to the fastest available Akamai CDN server.

## Getting Started

### Prerequisites
- [Node.js](https://nodejs.org/) installed (tested with v24.x)
- The required files `config.json5` and `ip_list.txt` must exist in the project root.

### Setup Steps
1.  **Install dependencies**:
    Clone or download this project, and in the project directory, run:
    ```bash
    npm install
    ```

2.  **Verify configuration**: Check `config.json5` to ensure the port (default: 2689) is available.

3.  **Start the proxy server**:
    ```bash
    npm start
    ```

4.  **Verify startup**: You should see output similar to this, confirming the server is running and has selected an optimal IP:
    ```bash
    Loaded 77 IP addresses from ip_list.txt 
    To update IPs manually, use the python script located at python/akamTester-master/akamTester.py.
    Pinging ipList
    forward proxy server started, listening on port 2689

    The best server is 2.16.11.163 which delay is 88.2417ms
    ```

5.  **Configure browser**: Set up a browser proxy extension to use the server. See the ZeroOmega Configuration section for a detailed example.

## ZeroOmega Configuration

To correctly use this proxy, you should configure a browser extension like [ZeroOmega](https://github.com/zero-peak/ZeroOmega) or [SwitchyOmega](https://github.com/FelisCatus/SwitchyOmega) to only proxy requests for the specific CDN domain. This avoids sending all your browser traffic through the proxy.

1.  **Create a new proxy profile** in the extension's options:
    *   **Profile Name**: `akam-proxy` (or any name you prefer)
    *   **Protocol**: `HTTP`
    *   **Server**: `127.0.0.1`
    *   **Port**: `2689` (or the port you configured in `config.json5`)

2.  **Set up auto-switching rules**:
    Create a rule to direct only Bilibili's CDN traffic through the proxy.
    *   **Condition Type**: `Host wildcard`
    *   **Condition Pattern**: `*.akamaized.net`
    *   **Profile**: Select the `akam-proxy` profile you created.

    This configuration ensures that only requests to the Bilibili CDN are routed through this proxy, while all other traffic is unaffected.

Screenshots of the ZeroOmega configuration:
![ZeroOmega Configuration](screenshots/ZeroOmega_Configuration.png)
![ZeroOmega Configuration](screenshots/ZeroOmega_Configuration_2.png)

## IP Address Management

The proxy's effectiveness depends on a good list of candidate IP addresses in `ip_list.txt`.

### Manual Update

You can quickly update `ip_list.txt` using DNS query tools like `nslookup` or `dig`:

```bash
nslookup upos-hz-mirrorakam.akamaized.net
```
Copy the resulting IP addresses into `ip_list.txt` (one IP per line) and restart the proxy server.

### Using akamTester (Recommended)

The project includes a powerful Python tool, `akamTester`, for discovering and testing a comprehensive list of Akamai CDN IPs.

1.  **Navigate to the tool's directory**:
    ```bash
    cd python/akamTester-master
    ```

2.  **Install Python dependencies**:
    ```bash
    pip install -r requirements.txt
    ```

3.  **Run the script for the target domain**:
    ```bash
    python akamTester.py -u upos-hz-mirrorakam.akamaized.net
    ```

4.  **Update `ip_list.txt`**:
    The script will test IPs and save a full list to a file named `upos-hz-mirrorakam.akamaized.net_iplist.txt`. Copy the contents of this file into the root `ip_list.txt`, replacing the old IPs. Restart the proxy server to use the new list.

## Future Development / TODO

-   **Automate `ip_list.txt` updates**: Integrate the `akamTester` Python script's results directly into the Node.js application. This would eliminate the manual copy-paste step and could involve:
    -   Having the Node.js server periodically execute the Python script to refresh the IP list.
    -   Automatically reading the output file (`upos-hz-mirrorakam.akamaized.net_iplist.txt`) generated by the Python script.
    -   Reloading the IP list in the running proxy without requiring a server restart.

- **Missing URLs**: The proxy-map.js is not handling all the possible cdns. Some cdns are not being proxied. Please update the proxy-map.js to handle all the possible cdns.
    - Example: upos-sz-mirroraliov.bilivideo.com
    - Example: upos-sz-mirrorawsov.bilivideo.com
    - Example: bimp.hdslb.com
    And more...

    Reconstructing the proxy-map.js to handle all the possible cdns.
